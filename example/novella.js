var Novella = (function (Vue) {
  'use strict';

  
  console.log("Generated by novella at 10/23/2016, 11:13:35 PM.");
  var data = {"title":"Ducks","pages":[{"index":0,"filename":"1-Mallard.png","location":"pages","mtime":"2016-10-22T21:28:22.000Z","width":450,"height":450},{"index":1,"filename":"2-Blue Billed.png","location":"pages","mtime":"2016-10-22T21:30:51.000Z","width":450,"height":450},{"index":2,"filename":"3-Peking.png","location":"pages","mtime":"2016-10-22T21:32:46.000Z","width":450,"height":450},{"index":3,"filename":"4-Mandarin.png","location":"pages","mtime":"2016-10-22T21:33:51.000Z","width":450,"height":450}]};

  Vue = 'default' in Vue ? Vue['default'] : Vue;

  var image = [".png",".gif",".jpg"];
  var formats = {
  	image: image
  };

  function isImage(filename) {
    var imageTypes = new Set(formats.image);
    var split = filename.split('.');
    var type = '.' + split[split.length - 1];
    return imageTypes.has(type);
  }

  var PageContent = { template: "<div class=\"page-content\"><img :src=\"src\" v-if=\"isImage()\" v-on:load=\"onLoad()\" :data-hidden=\"hidden\"></div>",
    props: { src: String },
    data: () => ({ hidden: true }),
    methods: {
      isImage() { return isImage(this.src); },
      onLoad() { this.hidden = false; },
    },
  };

  var page = {
    index: Number,
    filename: String,
    location: String,
    mtime: Date,
  };

  var pages = Array;

  var store$1 = {
    title: String,
    pages,
    pageroute: String,
    pagenum: Number,
    sidebar: Boolean,
  };

  var PageList = { template: "<ul class=\"page-list\" :style=\"{ height: getTotalHeight() + 'px' }\"><li v-for=\"n in Math.min(length, 10)\" :data-highlight=\"isSelected(n)\" :key=\"getSource(n)\" :style=\"{ top: positions[n] + 'px' }\"><a :href=\"getRoute(n)\"><page-content :src=\"getSource(n)\"></page-content><div class=\"pagenum\">{{ n }}</div></a></li></ul>",
    props: { store: store$1 },
    computed: {
      length() { return this.store.pages.length; },
      positions() {
        var total = 0;
        var positions = this.store.pages.map((page$$1, n) => {
          var top = total;
          total += this.computeHeight(n+1);
          return top;
        });
        positions.unshift(total);
        return positions;
      },
    },
    components: { PageContent },
    methods: {
      isSelected(n) {
        return n === this.store.pagenum;
      },
      handleClick(e) {
        this.clickPage(e.currentTarget.dataset.index);
      },
      getSource(n) {
        var page$$1 = this.store.pages[n-1];
        return `${page$$1.location}/${page$$1.filename}`;
      },
      getRoute(n) {
        var route = this.store.pageroute;
        if (!route) return null;
        return `${route}/${n}`;
      },
      getTotalHeight() {
        return this.positions[0];
      },
      computeHeight(n) {
        var WIDTH = 200;
        var MAX_IMAGE_HEIGHT = 200;
        var PAD = 16;

        var imageHeight;
        var page$$1 = this.store.pages[n-1];
        var ratio = page$$1.height / page$$1.width;

        if (ratio > 1) imageHeight = MAX_IMAGE_HEIGHT;
        else imageHeight = ratio * (WIDTH - PAD * 2);

        return imageHeight + PAD * 3;
      },
    },
  };

  function restrict(value, min, max) {
    var num = Number(value);
    num = Math.min(num, max);
    num = Math.max(num, min);
    return num;
  }

  function scrollToElement(parent, element) {
    var parentRect = parent.getBoundingClientRect();
    var elementRect = element.getBoundingClientRect();

    if (elementRect.bottom > parentRect.bottom) {
      return element.scrollIntoView(false);
    }

    if (elementRect.top < parentRect.top) {
      element.scrollIntoView(true);
    }
  }

  var Sidebar = { template: "<div class=\"sidebar\"><h1>{{ store.title }}</h1><page-list :store=\"store\" ref=\"pageList\"></page-list></div>",
      props: { store: store$1 },
      components: {
        PageList,
      },
      methods: {
        scrollToPage(n) {
          var list = this.$el.querySelectorAll('li');
          if (!list[n-1]) return;
          scrollToElement(this.$el, list[n-1]);
        },
      },
      mounted: function mounted() {
        this.scrollToPage(this.store.pagenum);
      },
      updated: function updated() {
        this.scrollToPage(this.store.pagenum);
      },
    };
  /*
  Lazy rendering notes:

  - sidebar: get current scroll position
    adjust for top position of pagelist:

    this.$el.getBoundingClientRect().top - this.$refs.pagelist.$el.getBoundingClientRect().top;

  - sidebar: compute which indices should be renderd
  - sidebar->pagelist: pass indices to render
  - pagelist: render the list, provide a height equal to total height
    can estimate? max-height for image is 200px, get average aspect ratio
    1:1 -> width of pagelist (200 - pad * 2)
    1:2 -> 200px
    1:0.5 -> width * 0.5


    imageHeight = 200 (when height > width, else...)
    imageHeight = (height / width) * (pagelistWidth)

    itemHeight = imageHeight + 3 * pad
    totalHeight = sum(itemHeight);

  - pagelist: render the provided indices, position them where expected.

  */

  var Page = { template: "<div class=\"page\"><div><page-content :src=\"getSource()\"></page-content></div><span>{{ new Date(page.mtime).toLocaleString() }}</span></div>",
    props: { page },
    components: { PageContent },
    methods: {
      getSource() {
        return `${this.page.location}/${this.page.filename}`;
      },
    },
  };

  var PageControl = { template: "<div class=\"page-control\"><a class=\"prev\" :href=\"getRoute(store.pagenum - 1)\" :disabled=\"!canPrev()\">prev ([ q) </a><a class=\"next\" :href=\"getRoute(store.pagenum + 1)\" :disabled=\"!canNext()\">(] w) next</a></div>",
    props: { store: store$1 },
    data: () => ({
      animateSidebar: null,
      hideSidebar: false,
    }),
    components: {
      Page,
      PageList,
    },
    methods: {
      canPrev() { return this.store.pagenum > 1; },
      canNext() { return this.store.pagenum < this.store.pages.length; },
      getRoute(n) {
        var route = this.store.pageroute;
        if (!route) return null;
        return `${route}/${n}`;
      },
    },
  };

  var Gallery = { template: "<div class=\"gallery\"><button class=\"sidebar-toggle\" v-on:click=\"toggleSidebar()\">{{ store.showsidebar ? 'hide menu' : 'show menu' }}</button><page :page=\"getPage(store.pagenum)\"></page><page-control :store=\"store\"></page-control></div>",
    props: { store: store$1 },
    components: {
      Page,
      PageControl,
    },
    methods: {
      getPage(n) {
        return this.store.pages[n - 1];
      },
      toggleSidebar() {
        var event = new CustomEvent('toggle:sidebar');
        document.dispatchEvent(event);
      },
    },
  };

  var App = { template: "<div class=\"app\"><transition name=\"slide\" v-on:after-enter=\"$refs.sidebar.scrollToPage(store.pagenum)\"><sidebar v-if=\"store.showsidebar\" :store=\"store\" ref=\"sidebar\"></sidebar></transition><gallery :store=\"store\"></gallery></div>",
    props: { store: store$1 },
    components: {
      Gallery,
      Sidebar,
    },
  };

  // from: http://krasimirtsonev.com/blog/article/A-modern-JavaScript-router-in-100-lines-history-api-pushState-hash-url

  var Router = {
      routes: [],
      mode: null,
      root: '/',
      config: function(options) {
          this.mode = options && options.mode && options.mode == 'history'
                      && !!(history.pushState) ? 'history' : 'hash';
          this.root = options && options.root ? '/' + this.clearSlashes(options.root) + '/' : '/';
          return this;
      },
      getFragment: function() {
          var fragment = '';
          if(this.mode === 'history') {
              fragment = this.clearSlashes(decodeURI(location.pathname + location.search));
              fragment = fragment.replace(/\?(.*)$/, '');
              fragment = this.root != '/' ? fragment.replace(this.root, '') : fragment;
          } else {
              var match = window.location.href.match(/#(.*)$/);
              fragment = match ? match[1] : '';
          }
          return this.clearSlashes(fragment);
      },
      clearSlashes: function(path) {
          return path.toString().replace(/\/$/, '').replace(/^\//, '');
      },
      add: function(re, handler) {
          if(typeof re == 'function') {
              handler = re;
              re = '';
          }
          this.routes.push({ re: re, handler: handler});
          return this;
      },
      remove: function(param) {
          for(var i=0, r; i<this.routes.length, r = this.routes[i]; i++) {
              if(r.handler === param || r.re.toString() === param.toString()) {
                  this.routes.splice(i, 1);
                  return this;
              }
          }
          return this;
      },
      flush: function() {
          this.routes = [];
          this.mode = null;
          this.root = '/';
          return this;
      },
      check: function(f) {
          var fragment = f || this.getFragment();
          for(var i=0; i<this.routes.length; i++) {
              var match = fragment.match(this.routes[i].re);
              if(match) {
                  match.shift();
                  this.routes[i].handler.apply({}, match);
                  return this;
              }
          }
          return this;
      },
      listen: function() {
          var self = this;
          var current = self.getFragment();
          var fn = function() {
              if(current !== self.getFragment()) {
                  current = self.getFragment();
                  self.check(current);
              }
          };
          clearInterval(this.interval);
          this.interval = setInterval(fn, 50);
          return this;
      },
      navigate: function(path) {
          path = path ? path : '';
          if(this.mode === 'history') {
              history.pushState(null, null, this.root + this.clearSlashes(path));
          } else {
              window.location.href = window.location.href.replace(/#(.*)$/, '') + '#' + path;
          }
          return this;
      },
  };

  /* globals data */

  var total = data.pages.length;
  var local = window.localStorage;

  var restrictPage = (n) => restrict(n, 1, total);

  var store = {
    title: data.title,
    pages: data.pages,
    pageroute: '#/page',
    pagenum: restrictPage(local.getItem('pagenum')),
    showsidebar: true,
  };

  Vue.component('app', App);
  Vue.component('page', Page);
  Vue.component('page-list', PageList);

  Router.config({ mode: 'hash' });
  Router.add(/page\/([\d\w]*)/, (pagenum) => {
    if (pagenum === 'last') pagenum = total;
    pagenum = restrictPage(pagenum);
    store.pagenum = pagenum;
    local.setItem('pagenum', pagenum);
  })
  .check(window.location.href)
  .listen();

  document.addEventListener('keypress', (e) => {
    var pagenum = store.pagenum;
    if (e.key === '[' || e.key === 'q') pagenum = restrictPage(store.pagenum - 1);
    if (e.key === ']' || e.key === 'w') pagenum = restrictPage(store.pagenum + 1);
    Router.navigate(`${store.pageroute}/${pagenum}`);
  });

  document.addEventListener('toggle:sidebar', () => {
    store.showsidebar = !store.showsidebar;
  });

  var app = new Vue({
    el: '#container',
    data: { store },
  });

  return app;

}(Vue));
